#!/bin/bash

set -e
set -u

prefix=__
delim=.
prog=$(basename $0)
PGDATABASE=${prog#*${delim}}
: ${PGPASSFILE=$HOME/.pgpass}
: ${PGHOST=$(hostname -s)}
: ${DBI_DRIVER=Pg}

if [ "${prog:0:2}" = "$prefix" ]
then

  name=${prog#${prefix}}
  dir=$(dirname $0)

  rm -f -v "$dir"/"$name$delim"*

  for database_and_user in $(cut -d: -f3-4 "$PGPASSFILE")
  do
    PGDATABASE=${database_and_user%%:*}
    PGUSER=${database_and_user#${PGDATABASE}:}
    if [ "$PGDATABASE" = "$PGUSER" ] ; then
      shorthand=${PGDATABASE}
    elif ! [ "${PGUSER#${PGDATABASE}}" = "$PGUSER" ] ; then
      shorthand=${PGUSER}
    else
      shorthand=${PGDATABASE}${delim}${PGUSER}
    fi
    linkname=${name}${delim}${shorthand}
    ln -v -s "$prog" "$dir/${linkname}"
  done

else

  if ! match=$(egrep < "$PGPASSFILE" -m 1 -e "^$PGHOST:[^:]*:$PGDATABASE:")
  then
    if ! match=$(egrep < "$PGPASSFILE" -m 1 -e "^localhost:[^:]*:$PGDATABASE:")
    then
      echo "no matching pgpass entry for $PGHOST:...:$PGDATABASE:..."
      exit 1
    fi
  fi
  PGHOST=${match%%:*}
  match=${match#*:}
  PGPORT=${match%%:*}
  match=${match#*:}
  PGDATABASE=${match%%:*}
  match=${match#*:}
  PGUSER=${match%%:*}

  export PGHOST PGPORT PGDATABASE PGUSER PGPASSFILE DBI_DRIVER

  exec -- "${@-psql}"
fi
